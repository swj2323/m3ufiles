name: wwkejishe AutoSync Download Workflow
on:
  workflow_dispatch:
  schedule:
    - cron: "40 17 * * *" # æ¯å¤©UTCæ—¶é—´17:40è§¦å‘ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥å‡Œæ™¨1:40ï¼‰

jobs:
  sync-iptv-sources:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ç¡®ä¿æœ‰å†™å…¥æƒé™

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: master # æ˜ç¡®æŒ‡å®šmasteråˆ†æ”¯

    - name: Create download directory
      run: mkdir -p Download

    - name: Download IPTV sources
      run: |
        curl -o Download/wwkejishe.m3u8 https://raw.githubusercontent.com/swj2323/iptv-api/refs/heads/master/Download/wwkejishe.m3u8

    - name: Process files
      run: |
       find Download -type f -name "*.m3u8" -exec sed -i -E \
       -e 's/^(#EXTINF:-1 group-title="([^"]+)"),([^\n]+)/#EXTINF:-1 group-title="\2" tvg-name="\3" tvg-logo="https:\/\/live.fanmingming.cn\/tv\/\3.png",\3/' \
       -e 's/\$.*$//' {} +

    - name: Commit changes
      run: |
        git config --global user.name "IPTV Sync Bot"
        git config --global user.email "iptv-sync@noreply.github.com"
        
        if [ -z "$(git status --porcelain)" ]; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
        else
          git add -A
          git commit -m "ğŸ“¡ AutoSync IPTV Sources [$(date +'%Y-%m-%d %H:%M UTC')]"
          git push origin master
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ç¡®ä¿ä»¤ç‰Œæœ‰æ•ˆ

    - name: Upload artifact (optional)
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: iptv-sources-${{ github.run_id }}
        path: Download/
        retention-days: 3
