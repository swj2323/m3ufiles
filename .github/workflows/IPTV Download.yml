name: IPTV Download

on:
  workflow_dispatch:
  schedule:
    - cron: "30 17 * * *"  # UTCæ—¶é—´17:30ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥1:30ï¼‰

jobs:
  sync-iptv-sources:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Create download directory
        run: mkdir -p Download

      - name: Download IPTV sources
        run: |
          wget -q -O Download/iptv-api.txt https://raw.githubusercontent.com/Guovin/iptv-api/gd/output/result.txt
          wget -q -O Download/wwkejishe.m3u https://iptv.wwkejishe.top/ALL.m3u
          wget -q -O Download/iptv-org.m3u https://iptv-org.github.io/iptv/countries/cn.m3u
          wget -q -O Download/CCTV.m3u https://raw.githubusercontent.com/Moexin/IPTV/Files/CCTV.m3u
          wget -q -O Download/l.txt https://raw.githubusercontent.com/asdjkl6/tv/tv/.m3u/æ•´å¥—ç›´æ’­æº/æµ‹è¯•/æ•´å¥—ç›´æ’­æº/l.txt
          wget -q -O Download/vbskycn_iptv6.txt https://raw.githubusercontent.com/vbskycn/iptv/master/tv/iptv6.txt
          wget -q -O Download/alienlu.txt https://raw.githubusercontent.com/alienlu/iptv/refs/heads/master/iptv.txt
          wget -q -O Download/allinone.m3u http://fn.sunweijun.top:35455/tv.m3u

      - name: Process files
        run: |
          find Download -type f -exec sed -i \
            # æ–°å¢å°å†™cctvå¤„ç†ï¼ˆåŒ¹é…1-17é¢‘é“ï¼‰
            -e 's/cctv$[1-9]\|1[0-7]$-BPTV/CCTV\1/gi' \
            # ä¼˜åŒ–åŸºç¡€æ ¼å¼å¤„ç†
            -e 's/[Cc][Cc][Tt][Vv][-_]$[0-9]\+$[-+_ ]*.*/CCTV\1/g' \
            # å…¶ä»–é¢‘é“å¤„ç†
            -e 's/BRTV$åŒ—äº¬å«è§†\|å¡é…·å°‘å„¿\|çºªå®ç§‘æ•™$/\1/g' \
            -e 's/NewTV$è¶…çº§ç”µè§†å‰§\|è¶…çº§ç”µå½±\|è¶…çº§ä½“è‚²\|è¶…çº§ç»¼è‰º$/\1/g' \
            -e 's/SiTV$[^ ]\+$/\1/g' \
            -e 's/iHOTçˆ±$[^ ]\+$/çˆ±\1/g' \
            -e 's/ä¸Šæµ·ä¸œæ–¹å«è§†/ä¸œæ–¹å«è§†/g' \
            -e 's/ç¦å»ºä½“è‚²é¢‘é“\?/ç¦å»ºæ–‡ä½“/g' \
            -e 's/å¡é…·å°‘å„¿/å¡é…·åŠ¨ç”»/g' \
            -e 's/CGTNè®°å½•/CGTNçºªå½•/g' {} +

          sed -i 's|https://gcore.jsdelivr.net/gh/.*/icon/|https://raw.githubusercontent.com/fanmingming/live/main/tv/|g' Download/wwkejishe.m3u

      - name: Commit changes
        run: |
          git config --global user.name "IPTV Sync Bot"
          git config --global user.email "iptv-sync@noreply.github.com"
          
          git add -A
          if ! git diff-index --quiet HEAD --; then
            git commit -m "ğŸ“¡ AutoSync IPTV Sources $(date +'%Y-%m-%d %H:%M UTC')"
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
