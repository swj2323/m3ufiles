name: IPTV AutoSync Workflow

on:
  workflow_dispatch:
  schedule:
    - cron: "30 17 * * *" # æ¯å¤©UTCæ—¶é—´17ç‚¹30åˆ†ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥1ç‚¹30åˆ†ï¼‰

jobs:
  sync-iptv-sources:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¡®ä¿æœ‰å†™å…¥æƒé™â€Œ:ml-citation{ref="1,6" data="citationList"}
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºmasteråˆ†æ”¯ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master  # æ˜ç¡®æŒ‡å®šmasteråˆ†æ”¯â€Œ:ml-citation{ref="1" data="citationList"}

      # æ­¥éª¤2ï¼šåˆ›å»ºä¸‹è½½ç›®å½•
      - name: Create download directory
        run: mkdir -p Download

      # æ­¥éª¤3ï¼šä¸‹è½½IPTVæºæ–‡ä»¶
      - name: Download IPTV sources
        run: |
          wget -q -O Download/iptv-api.txt https://raw.githubusercontent.com/Guovin/iptv-api/gd/output/result.txt
          wget -q -O Download/wwkejishe.m3u https://iptv.wwkejishe.top/ALL.m3u
          wget -q -O Download/wwkjtv.m3u https://iptv.wwkejishe.top/tv.m3u
          wget -q -O Download/wwkjSub.m3u https://iptv.wwkejishe.top/Sub.m3u
          wget -q -O Download/CCTV.m3u https://raw.githubusercontent.com/Moexin/IPTV/Files/CCTV.m3u
          wget -q -O Download/CNTV.m3u https://raw.githubusercontent.com/Moexin/IPTV/Files/CNTV.m3u
          wget -q -O Download/suxuang.m3u https://raw.githubusercontent.com/suxuang/myIPTV/main/ipv6.m3u
          wget -q -O Download/l.txt https://raw.githubusercontent.com/asdjkl6/tv/tv/.m3u/æ•´å¥—ç›´æ’­æº/æµ‹è¯•/æ•´å¥—ç›´æ’­æº/l.txt
          wget -q -O Download/fanmingming_ipv6.m3u https://raw.githubusercontent.com/fanmingming/live/main/tv/m3u/ipv6.m3u
          wget -q -O Download/vbskycn_iptv6.txt https://raw.githubusercontent.com/vbskycn/iptv/master/tv/iptv6.txt
          wget -q -O Download/YueChan.m3u https://raw.githubusercontent.com/YueChan/Live/main/APTV.m3u
          wget -q -O Download/alienlu.txt https://raw.githubusercontent.com/alienlu/iptv/refs/heads/master/iptv.txt

      # æ­¥éª¤4ï¼šæ‰¹é‡æ›¿æ¢æ–‡ä»¶å†…å®¹
      - name: Process files
        run: |
          find Download -type f -exec sed -i \
            -e 's/CCTV-/CCTV/g' \
            -e 's/CCTV /CCTV/g' \
            -e 's/CCTV-0/CCTV/g' \
            -e 's/CCTV0/CCTV/g' \
            -e 's/CCTV-1 ç»¼åˆ/CCTV1/g' \
            -e 's/CCTV-2 è´¢ç»/CCTV2/g' \
            -e 's/CCTV-3 ç»¼è‰º/CCTV3/g' \
            -e 's/CCTV-4 ä¸­æ–‡å›½é™…/CCTV4/g' \
            -e 's/CCTV-5 ä½“è‚²/CCTV5/g' \
            -e 's/CCTV-5+ ä½“è‚²èµ›äº‹/CCTV5+/g' \
            -e 's/CCTV-6 ç”µå½±/CCTV6/g' \
            -e 's/CCTV-7 å›½é˜²å†›äº‹/CCTV7/g' \
            -e 's/CCTV-8 ç”µè§†å‰§/CCTV8/g' \
            -e 's/CCTV-9 çºªå½•/CCTV9/g' \
            -e 's/CCTV-10 ç§‘æ•™/CCTV10/g' \
            -e 's/CCTV-11 æˆæ›²/CCTV11/g' \
            -e 's/CCTV-12 ç¤¾ä¼šä¸æ³•/CCTV12/g' \
            -e 's/CCTV-13 æ–°é—»/CCTV13/g' \
            -e 's/CCTV-14 å°‘å„¿/CCTV14/g' \
            -e 's/CCTV-15 éŸ³ä¹/CCTV15/g' \
            -e 's/CCTV-16 å¥¥æ—åŒ¹å…‹/CCTV16/g' \
            -e 's/CCTV-17 å†œä¸šå†œæ‘/CCTV17/g' \
            -e 's/CCTV-1ç»¼åˆ/CCTV1/g' \
            -e 's/CCTV-2è´¢ç»/CCTV2/g' \
            -e 's/CCTV-3ç»¼è‰º/CCTV3/g' \
            -e 's/CCTV-4ä¸­æ–‡å›½é™…/CCTV4/g' \
            -e 's/CCTV-5ä½“è‚²/CCTV5/g' \
            -e 's/CCTV-5+ä½“è‚²èµ›äº‹/CCTV5+/g' \
            -e 's/CCTV-6ç”µå½±/CCTV6/g' \
            -e 's/CCTV-7å›½é˜²å†›äº‹/CCTV7/g' \
            -e 's/CCTV-8ç”µè§†å‰§/CCTV8/g' \
            -e 's/CCTV-9çºªå½•/CCTV9/g' \
            -e 's/CCTV-10ç§‘æ•™/CCTV10/g' \
            -e 's/CCTV-11æˆæ›²/CCTV11/g' \
            -e 's/CCTV-12ç¤¾ä¼šä¸æ³•/CCTV12/g' \
            -e 's/CCTV-13æ–°é—»/CCTV13/g' \
            -e 's/CCTV-14å°‘å„¿/CCTV14/g' \
            -e 's/CCTV-15éŸ³ä¹/CCTV15/g' \
            -e 's/CCTV-16å¥¥æ—åŒ¹å…‹/CCTV16/g' \
            -e 's/CCTV-17å†œä¸šå†œæ‘/CCTV17/g' \
            -e 's/CCTV1 ç»¼åˆ/CCTV1/g' \
            -e 's/CCTV2 è´¢ç»/CCTV2/g' \
            -e 's/CCTV3 ç»¼è‰º/CCTV3/g' \
            -e 's/CCTV4 ä¸­æ–‡å›½é™…/CCTV4/g' \
            -e 's/CCTV5 ä½“è‚²/CCTV5/g' \
            -e 's/CCTV5+ ä½“è‚²èµ›äº‹/CCTV5+/g' \
            -e 's/CCTV6 ç”µå½±/CCTV6/g' \
            -e 's/CCTV7 å›½é˜²å†›äº‹/CCTV7/g' \
            -e 's/CCTV8 ç”µè§†å‰§/CCTV8/g' \
            -e 's/CCTV9 çºªå½•/CCTV9/g' \
            -e 's/CCTV10 ç§‘æ•™/CCTV10/g' \
            -e 's/CCTV11 æˆæ›²/CCTV11/g' \
            -e 's/CCTV12 ç¤¾ä¼šä¸æ³•/CCTV12/g' \
            -e 's/CCTV13 æ–°é—»/CCTV13/g' \
            -e 's/CCTV14 å°‘å„¿/CCTV14/g' \
            -e 's/CCTV15 éŸ³ä¹/CCTV15/g' \
            -e 's/CCTV16 å¥¥æ—åŒ¹å…‹/CCTV16/g' \
            -e 's/CCTV17 å†œä¸šå†œæ‘/CCTV17/g' \
            -e 's/CGTNè®°å½•/CGTNçºªå½•/g' \
            -e 's/BRTVåŒ—äº¬å«è§†/åŒ—äº¬å«è§†/g' \
            -e 's/BRTVå¡é…·å°‘å„¿/å¡é…·å°‘å„¿/g' \
            -e 's/BRTVçºªå®ç§‘æ•™/çºªå®ç§‘æ•™/g' \
            -e 's/ä¸Šæµ·ä¸œæ–¹å«è§†/ä¸œæ–¹å«è§†/g' \
            -e 's/ç¦å»ºæµ·å³¡å«è§†/æµ·å³¡å«è§†/g' \
            -e 's/ç¦å»ºä½“è‚²/ç¦å»ºæ–‡ä½“/g' \
            -e 's/ç¦å»ºä½“è‚²é¢‘é“/ç¦å»ºæ–‡ä½“/g' \
            -e 's/NewTVçˆ±æƒ…å–œå‰§/çˆ±æƒ…å–œå‰§/g' \
            -e 's/NewTVè¶…çº§ç”µè§†å‰§/è¶…çº§ç”µè§†å‰§/g' \
            -e 's/NewTVè¶…çº§ç”µå½±/è¶…çº§ç”µå½±/g' \
            -e 's/NewTVè¶…çº§ä½“è‚²/è¶…çº§ä½“è‚²/g' \
            -e 's/NewTVè¶…çº§ç»¼è‰º/è¶…çº§ç»¼è‰º/g' \
            -e 's/NewTVæ½®å¦ˆè¾£å©†/æ½®å¦ˆè¾£å©†/g' \
            -e 's/NewTVä¸œåŒ—çƒ­å‰§/ä¸œåŒ—çƒ­å‰§/g' \
            -e 's/NewTVåŠ¨ä½œç”µå½±/åŠ¨ä½œç”µå½±/g' \
            -e 's/NewTVå¤è£…å‰§åœº/å¤è£…å‰§åœº/g' \
            -e 's/NewTVæ¬¢ä¹å‰§åœº/æ¬¢ä¹å‰§åœº/g' \
            -e 's/NewTVå®¶åº­å‰§åœº/å®¶åº­å‰§åœº/g' \
            -e 's/NewTVé‡‘ç‰Œç»¼è‰º/é‡‘ç‰Œç»¼è‰º/g' \
            -e 's/NewTVæƒŠæ‚šæ‚¬ç–‘/æƒŠæ‚šæ‚¬ç–‘/g' \
            -e 's/NewTVç²¾å“å¤§å‰§/ç²¾å“å¤§å‰§/g' \
            -e 's/NewTVç²¾å“çºªå½•/ç²¾å“çºªå½•/g' \
            -e 's/NewTVç²¾å“èŒå® /ç²¾å“èŒå® /g' \
            -e 's/NewTVç²¾å“ä½“è‚²/ç²¾å“ä½“è‚²/g' \
            -e 's/SiTVåŠ¨æ¼«ç§€åœº/åŠ¨æ¼«ç§€åœº/g' \
            -e 's/SiTVéƒ½å¸‚å‰§åœº/éƒ½å¸‚å‰§åœº/g' \
            -e 's/SiTVæ³•æ²»å¤©åœ°/æ³•æ²»å¤©åœ°/g' \
            -e 's/SiTVæ¬¢ç¬‘å‰§åœº/æ¬¢ç¬‘å‰§åœº/g' \
            -e 's/SiTVé‡‘è‰²å­¦å ‚/é‡‘è‰²å­¦å ‚/g' \
            -e 's/SiTVåŠ²çˆ†ä½“è‚²/åŠ²çˆ†ä½“è‚²/g' \
            -e 's/SiTVä¹æ¸¸/ä¹æ¸¸/g' \
            -e 's/SiTVé­…åŠ›è¶³çƒ/é­…åŠ›è¶³çƒ/g' \
            -e 's/SiTVä¸ƒå½©æˆå‰§/ä¸ƒå½©æˆå‰§/g' \
            -e 's/SiTVç”Ÿæ´»æ—¶å°š/ç”Ÿæ´»æ—¶å°š/g' \
            -e 's/SiTVæ¸¸æˆé£äº‘/æ¸¸æˆé£äº‘/g' \
            -e 's/iHOTçˆ±è°æˆ˜/çˆ±è°æˆ˜/g' \
            -e 's/iHOTçˆ±éƒ½å¸‚/çˆ±éƒ½å¸‚/g' \
            -e 's/iHOTçˆ±æ€€æ—§/çˆ±æ€€æ—§/g' \
            -e 's/iHOTçˆ±ç»å…¸/çˆ±ç»å…¸/g' \
            -e 's/iHOTçˆ±ç§‘å¹»/çˆ±ç§‘å¹»/g' \
            -e 's/iHOTçˆ±æµªæ¼«/çˆ±æµªæ¼«/g' \
            -e 's/iHOTçˆ±å†å²/çˆ±å†å²/g' \
            -e 's/iHOTçˆ±é’æ˜¥/çˆ±é’æ˜¥/g' \
            -e 's/iHOTçˆ±å–œå‰§/çˆ±å–œå‰§/g' \
            -e 's/iHOTçˆ±æ‚¬ç–‘/çˆ±æ‚¬ç–‘/g' \
            -e 's/iHOTçˆ±åŠ¨æ¼«/çˆ±åŠ¨æ¼«/g' \
            -e 's/iHOTçˆ±ç©å…·/çˆ±ç©å…·/g' \
            -e 's/iHOTçˆ±å¹¼æ•™/çˆ±å¹¼æ•™/g' \
            -e 's/iHOTçˆ±ç§‘å­¦/çˆ±ç§‘å­¦/g' \
            -e 's/iHOTçˆ±æ—…è¡Œ/çˆ±æ—…è¡Œ/g' \
            -e 's/iHOTçˆ±ä½“è‚²/çˆ±ä½“è‚²/g' \
            {} +

      # æ­¥éª¤5ï¼šè‡ªåŠ¨æäº¤æ›´æ–°ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰
      - name: Commit changes
        run: |
          git config --global user.name "IPTV Sync Bot"
          git config --global user.email "iptv-sync@noreply.github.com"

          # æ›´å¯é çš„å˜æ›´æ£€æµ‹æ–¹æ³•â€Œ:ml-citation{ref="6" data="citationList"}
          if [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
          else
            # æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ–°å»ºæ–‡ä»¶ï¼‰â€Œ:ml-citation{ref="6" data="citationList"}
            git add -A
            git commit -m "ğŸ“¡ AutoSync IPTV Sources [$(date +'%Y-%m-%d %H:%M UTC')]"
            # å¼ºåˆ¶æ¨é€ç¡®ä¿åŒæ­¥â€Œ:ml-citation{ref="1,3" data="citationList"}
            git push origin master
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ç¡®ä¿ä»¤ç‰Œæœ‰æ•ˆâ€Œ:ml-citation{ref="1,6" data="citationList"}

      # æ­¥éª¤6ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: iptv-sources-${{ github.run_id }}
          path: Download/
          retention-days: 3
